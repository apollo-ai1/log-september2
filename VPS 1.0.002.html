<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Investech Visual PlayerCode Studio</title>
    <meta name="description"
        content="Investech Visual PlayerCode Studio - A melhor ferramenta para desenvolvimento visual." />
    <meta name="keywords" content="Investech, Visual PlayerCode, Studio, Desenvolvimento, Ferramenta" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;500;700&display=swap"
        rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.css"
        rel="stylesheet" />
    <style>
        :root {
            /* Cores principais */
            --primary-color: #3a5a78;
            --secondary-color: #7c9cb0;
            --accent-color: #e8c547;

            /* Cores de fundo */
            --background-color: #f5f7fa;
            --card-background: #ffffff;

            /* Cores de texto */
            --text-color-primary: #2c3e50;
            --text-color-secondary: #34495e;
            --text-color-light: #7f8c8d;

            /* Cores de estado */
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --error-color: #e74c3c;

            /* Estilos de UI */
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition-duration: 0.3s;

            /* Dimensões */
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 70px;

            /* Gradientes */
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --gradient-accent: linear-gradient(135deg, var(--accent-color), #f5d76e);

            /* Fontes */
            --font-family: 'Roboto', sans-serif;
            --font-size-base: 16px;
            --font-weight-normal: 400;
            --font-weight-bold: 700;

            /* Espaçamento */
            --spacing-small: 8px;
            --spacing-medium: 16px;
            --spacing-large: 24px;
        }

        /* Reset CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            /* Tipografia */
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Oxygen, Ubuntu, Cantarell, sans-serif;
            font-size: 16px;
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;

            /* Cores */
            background-color: var(--background-color);
            color: var(--text-color);

            /* Layout */
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;

            /* Comportamento */
            box-sizing: border-box;
            scroll-behavior: smooth;

            /* Otimização */
            text-rendering: optimizeLegibility;
            -webkit-text-size-adjust: 100%;

            /* Acessibilidade */
            word-wrap: break-word;
            -webkit-tap-highlight-color: transparent;
        }

        /* Reset para todos os elementos */
        *,
        *::before,
        *::after {
            box-sizing: inherit;
            margin: 0;
            padding: 0;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: var(--box-shadow);
            position: fixed;
            top: 0;
            left: 0;
            padding: 20px;
            z-index: 3000;
            transition: width var(--transition-duration);
            backdrop-filter: blur(80px);
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }

        .sidebar .logo {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity var(--transition-duration);
        }

        .sidebar.collapsed .logo-text {
            display: none;
        }

        .globe {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            position: relative;
            animation: spin 8s linear infinite;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-right: 10px;
        }

        .globe::before,
        .globe::after {
            content: '';
            position: absolute;
            border-radius: 50%;
        }

        .globe::before {
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .globe::after {
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1), rgba(0, 0, 0, 0.1));
            mix-blend-mode: overlay;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .sidebar .nav-item {
            margin-bottom: 20px;
        }

        .sidebar .nav-item a {
            color: var(--text-color);
            text-decoration: none;
            font-size: 16px;
            display: flex;
            align-items: center;
            transition: color var(--transition-duration);
        }

        .sidebar .nav-item a i {
            margin-right: 10px;
        }

        .sidebar.collapsed .nav-item a {
            justify-content: center;
        }

        .sidebar.collapsed .nav-item a i {
            margin-right: 0;
        }

        .sidebar.collapsed .nav-item a .nav-text {
            display: none;
        }

        /* Toggle Button */
        .toggle-btn {
            position: absolute;
            top: 50%;
            left: var(--sidebar-width);
            transform: translateY(-50%);
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform var(--transition-duration), left var(--transition-duration);
            z-index: 4000;
        }

        .toggle-btn.collapsed {
            transform: translateY(-50%) rotate(180deg);
            left: var(--sidebar-collapsed-width);
        }

        /* Content */
        .content {
            margin-left: var(--sidebar-width);
            padding: 20px;
            transition: margin-left var(--transition-duration);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .content.collapsed {
            margin-left: var(--sidebar-collapsed-width);
        }

        .content .header {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 30px;
            width: 100%;
        }

        .content .header .title {
            font-size: 24px;
            font-weight: 700;
        }

        .content .header .search {
            display: flex;
            align-items: center;
            position: relative;
        }

        .content .header .search input {
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 5px 15px;
            margin-right: 10px;
            transition: border-color var(--transition-duration), transform var(--transition-duration);
            width: 200px;
        }

        .content .header .search button {
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
            color: #fff;
            border: none;
            border-radius: var(--border-radius);
            padding: 5px 15px;
            cursor: pointer;
            transition: background-color var(--transition-duration), transform var(--transition-duration);
            margin-left: 10px;
        }

        .content .header .search button:hover {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            transform: scale(1.05);
        }

        /* Main Container */
        .main-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .main-content {
            width: 700px;
            height: 400px;
            background-color: #ffffff;
            box-shadow: var(--box-shadow);
            border-radius: 10px;
            margin-right: 20px;
            overflow: hidden;
        }

        .side-content {
            width: 400px;
            height: 500px;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: var(--box-shadow);
            border-radius: 10px;
            position: relative;
            top: 0px;
            backdrop-filter: blur(80px);
            padding: 20px;
        }

        /* CodeMirror */
        .CodeMirror {
            height: 100%;
            font-family: 'Source Code Pro', monospace;
            background-color: #f0f0f0;
        }

        .preview {
            width: 100%;
            height: 100%;
            border: none;
        }

        .logo-text {
            display: flex;
            align-items: center;
        }

        .logo-text span {
            font-size: 14px;
            color: var(--text-color);
        }

        .CodeMirror-hints {
            font-family: 'Source Code Pro', monospace;
            font-size: 14px;
        }

        .CodeMirror-hint {
            color: #ccc;
        }

        /* Popup */
        .popup {
            position: absolute;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid #ddd;
            border-radius: 50%;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1000;
            cursor: pointer;
            transition: all var(--transition-duration) ease;
        }

        .popup:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.1);
        }

        .popup i {
            color: var(--primary-color);
        }

        /* Message Container */
        .message-container {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        .message-container input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 5px 15px;
            margin-right: 10px;
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
            color: #fff;
        }

        .message-container button {
            background: linear-gradient(45deg, var(--secondary-color), var(--primary-color));
            color: #fff;
            border: none;
            border-radius: var(--border-radius);
            padding: 5px 15px;
            cursor: pointer;
            transition: background-color var(--transition-duration), transform var(--transition-duration);
        }

        .message-container button:hover {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            transform: scale(1.05);
        }

        /* Chat Popup */
        .chat-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            background: #fff;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.1);
            border-radius: var(--border-radius);
            overflow: hidden;
            z-index: 5000;
            display: none;
            transition: all var(--transition-duration) ease;
        }

        .chat-popup.active {
            display: block;
            animation: popIn var(--transition-duration) ease forwards;
        }

        @keyframes popIn {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .chat-popup .header {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: #fff;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-popup .header h4 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .chat-popup .header .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            transition: transform var(--transition-duration) ease;
        }

        .chat-popup .header .close-btn:hover {
            transform: rotate(90deg);
        }

        .chat-popup .body {
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .chat-popup .body input {
            border: 1px solid #e0e0e0;
            border-radius: var(--border-radius);
            padding: 10px 15px;
            margin-bottom: 10px;
            font-size: 14px;
            transition: border-color var(--transition-duration) ease;
        }

        .chat-popup .body input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .chat-popup .body button {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: #fff;
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform var(--transition-duration) ease, box-shadow var(--transition-duration) ease;
        }

        .chat-popup .body button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
        }

        /* Loading Notification */
        .loading-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            animation: slideIn var(--transition-duration) ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .loading-animation p {
            color: white;
            margin-top: 10px;
        }

        /* Autonomous Mode */
        #autonomous-mode-btn {
            background: linear-gradient(45deg, #000000, #800080);
            color: #fff;
            border: none;
            border-radius: var(--border-radius);
            padding: 5px 15px;
            cursor: pointer;
            transition: transform var(--transition-duration), box-shadow var(--transition-duration);
            margin-left: 10px;
        }

        #autonomous-mode-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(128, 0, 128, 0.5);
        }

        #autonomous-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.5s ease;
            background: linear-gradient(45deg, #000000, #800080, #000000, #800080);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            pointer-events: none;
        }

        @keyframes gradientBG {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        body.autonomous-mode {
            transition: background-color 0.5s ease;
        }

        body.autonomous-mode .sidebar,
        body.autonomous-mode .content,
        body.autonomous-mode .main-content,
        body.autonomous-mode .side-content {
            transition: background-color 0.5s ease, box-shadow 0.5s ease;
        }

        body.autonomous-mode .sidebar {
            background: rgba(0, 0, 0, 0.7);
        }

        body.autonomous-mode .content {
            background: rgba(0, 0, 0, 0.5);
        }

        body.autonomous-mode .main-content,
        body.autonomous-mode .side-content {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 12px rgba(128, 0, 128, 0.3);
        }

        body.autonomous-mode .CodeMirror {
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
        }

        body.autonomous-mode .CodeMirror-gutters {
            background-color: rgba(0, 0, 0, 0.8);
            border-right: 1px solid rgba(128, 0, 128, 0.3);
        }

        body.autonomous-mode .CodeMirror-linenumber {
            color: rgba(255, 255, 255, 0.5);
        }

        /* Autonomous Popup */
        .autonomous-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .autonomous-popup {
            display: flex;
            /* Flexbox para centralizar o conteúdo */
            justify-content: center;
            /* Centraliza horizontalmente */
            align-items: center;
            /* Centraliza verticalmente */
            position: fixed;
            /* Fixa na tela */
            top: 0;
            /* Alinha ao topo */
            left: 0;
            /* Alinha à esquerda */
            width: 100%;
            /* Largura total */
            height: 100%;
            /* Altura total */
            background-color: rgba(0, 0, 0, 0.7);
            /* Fundo escuro com opacidade */
            backdrop-filter: blur(25px);
            /* Efeito de desfoque */
            z-index: 9999;
            /* Fixa acima de outros elementos */
        }

        .autonomous-popup-content {
            background-color: rgba(169, 169, 169, 0.9);
            /* Cinza titânio claro com leve transparência */
            border-radius: 15px;
            /* Bordas arredondadas */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            /* Sombra suave */
            padding: 30px;
            /* Espaçamento interno */
            width: 90%;
            /* Largura responsiva */
            max-width: 500px;
            /* Largura máxima */
            position: relative;
            /* Para posicionar o botão de fechar */
            animation: slideIn 0.3s ease;
            /* Animação de entrada */
        }

        /* Estilo do cabeçalho */
        .autonomous-popup-content h2 {
            font-size: 24px;
            /* Tamanho da fonte do título */
            font-weight: bold;
            /* Negrito */
            color: #ffffff;
            /* Cor do texto branca */
            margin-bottom: 20px;
            /* Margem inferior */
            text-align: center;
            /* Centraliza o texto */
        }

        /* Estilo dos inputs */
        .autonomous-input-group {
            margin-bottom: 15px;
            /* Margem inferior para espaçamento */
        }

        .autonomous-input-group label {
            font-size: 14px;
            /* Tamanho da fonte do rótulo */
            color: #ffffff;
            /* Cor do texto branca */
            display: block;
            /* Exibe como bloco */
            margin-bottom: 5px;
            /* Margem inferior */
        }

        .autonomous-input-group input {
            width: 100%;
            /* Largura total */
            padding: 10px;
            /* Espaçamento interno */
            border: 1px solid #ddd;
            /* Borda cinza */
            border-radius: 5px;
            /* Bordas arredondadas */
            font-size: 14px;
            /* Tamanho da fonte */
            color: #ffffff;
            /* Cor do texto branca */
            background-color: rgba(255, 255, 255, 0.1);
            /* Fundo levemente transparente */
            transition: border-color 0.3s;
            /* Transição suave para a cor da borda */
        }

        .autonomous-input-group input:focus {
            border-color: #00d4ff;
            /* Cor da borda ao focar */
            outline: none;
            /* Remove o contorno padrão */
        }

        /* Estilo dos botões */
        .autonomous-button-group {
            display: flex;
            /* Flexbox para os botões */
            justify-content: space-between;
            /* Espaçamento entre os botões */
        }

        .autonomous-button {
            background: linear-gradient(45deg, #007bff, #00d4ff);
            /* Gradiente de fundo */
            color: #ffffff;
            /* Cor do texto branca */
            border: none;
            /* Sem borda */
            border-radius: 5px;
            /* Bordas arredondadas */
            padding: 10px 15px;
            /* Espaçamento interno */
            cursor: pointer;
            /* Muda o cursor ao passar o mouse */
            transition: background 0.3s, transform 0.3s;
            /* Transições suaves */
        }

        .autonomous-button:hover {
            background: linear-gradient(45deg, #00d4ff, #007bff);
            /* Inverte o gradiente ao passar o mouse */
            transform: scale(1.05);
            /* Aumenta ligeiramente o botão */
        }

        /* Estilo do botão de fechar */
        .close-modal {
            position: absolute;
            /* Posiciona no canto superior direito */
            top: 15px;
            /* Distância do topo */
            right: 15px;
            /* Distância da direita */
            background: none;
            /* Sem fundo */
            border: none;
            /* Sem bord a */
            font-size: 24px;
            /* Tamanho do ícone */
            color: #ffffff;
            /* Cor do ícone branca */
            cursor: pointer;
            /* Muda o cursor ao passar o mouse */
            transition: color 0.3s;
            /* Transição suave para a cor */
        }

        .close-modal:hover {
            color: #e74c3c;
            /* Cor ao passar o mouse */
        }

        /* Animação de entrada */
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                /* Começa acima */
                opacity: 0;
                /* Começa invisível */
            }

            to {
                transform: translateY(0);
                /* Termina na posição original */
                opacity: 1;
                /* Termina visível */
            }
        }

        /* Pause Button */
        #pause-btn {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: #fff;
            border: none;
            border-radius: var(--border-radius);
            padding: 5px 15px;
            cursor: pointer;
            transition: background-color var(--transition-duration), transform var(--transition-duration);
            margin-left: 10px;
        }

        #pause-btn:hover {
            background: linear-gradient(45deg, #feca57, #ff6b6b);
            transform: scale(1.05);
        }

        /* Version Item */
        .version-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
        }

        .version-thumbnail {
            width: 100px;
            height: 60px;
            object-fit: cover;
            margin-right: 15px;
            border-radius: 3px;
        }

        /*Pop-up style */

        .premium-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            background: #fff;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            z-index: 10000;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .premium-popup-content {
            padding: 20px;
        }

        .premium-popup h2 {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .premium-popup button {
            background: linear-gradient(45deg, #007bff, #00d4ff);
            color: #fff;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            margin-top: 10px;
        }

        .premium-popup button:hover {
            background: linear-gradient(45deg, #00d4ff, #007bff);
            transform: scale(1.05);
        }

        /* page dark and light theme */

        /* Adicione este CSS para o tema escuro */
        body.dark-theme {
            background-color: #121212;
            color: #ffffff;
        }

        body.dark-theme .sidebar {
            background: rgba(179, 179, 179, 0.1);
        }

        body.dark-theme .content {
            background: rgba(255, 255, 255, 0.1);
        }

        body.dark-theme a {
            color: #ffffff;
        }

        body.dark-theme h1 {

            color: #ffffff;
        }

        body.dark-theme h2 {
            color: #ffffff;
        }

        body.dark-theme h3 {
            color: #ffffff;
        }

        body.dark-theme h4 {
            color: #ffffff;
        }

        body.dark-theme h5 {
            color: #ffffff;
        }

        body.dark-theme h6 {
            color: #ffffff;
        }

        body.dark-theme p {
            color: #ffffff;
        }

        body.dark-theme .nav-text {
            color: #ffffff;
        }

        body.dark-theme i {
            color: #ffffff;
        }

        body.dark-theme .nav-text:hover {
            color: #c7c7c7;
        }

        body.dark-theme .nav-text:active {
            color: #ffffff;
        }

        body.dark-theme .nav-text:visited {
            color: #ffffff;
        }

        body.dark-theme .nav-text:link {
            color: #ffffff;
        }

        body.dark-theme .nav-text:target {
            color: #ffffff;
        }

        body.dark-theme .nav-text:visited {
            color: #ffffff;
        }

        body.dark-theme .nav-text:active {
            color: #ffffff;
        }

        body.dark-theme .nav-text:link {
            color: #ffffff;
        }

        body.dark-theme .nav-text:target {
            color: #ffffff;
        }

        body.dark-theme .nav-text:visited {
            color: #ffffff;
        }

        body.dark-theme .nav-text:active {
            color: #ffffff;
        }

        body.dark-theme .nav-text:link {
            color: #ffffff;
        }

        body.dark-theme .nav-text:target {
            color: #ffffff;
        }

        body.dark-theme .vps-text {
            color: #ffffff;
        }

        body.dark-theme .vps-text:visited {
            color: #ffffff;
        }

        body.dark-theme .vps-text:link {
            color: #ffffff;
        }

        body.dark-theme .vps-text:target {
            color: #ffffff;
        }

        body.dark-theme .investech-text {
            color: #ffffff;
        }

        body.dark-theme .investech-text:visited {
            color: #ffffff;
        }

        body.dark-theme .investech-text:link {
            color: #ffffff;
        }

        body.dark-theme .investech-text:target {
            color: #ffffff;
        }

        body.dark-theme .investech-text:active {
            color: #ffffff;
        }

        .aviso {
            position: fixed;
            bottom: 50px;
            left: 0;
            width: 100%;
            background-color: #ff0000;
            color: #ffffff;
            text-align: center;
            padding: 4px;
            font-size: 12px;
            z-index: 9999;
        }

        /* Estilos do botão de tema */
        #theme-toggle-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: -10px;
        }

        /* Estilos do ícone */
        #theme-toggle-btn i {
            font-size: 20px;
            transition: all 0.3s ease;
        }

        /* Cores dos ícones */
        #theme-toggle-btn i.fa-moon {
            color: #6e6e6e;
            /* Cor mais escura para a lua no tema claro */
        }

        .dark-theme #theme-toggle-btn i.fa-sun {
            color: #ffd700;
            /* Cor dourada para o sol no tema escuro */
        }

        /* Animação de rotação */
        .theme-icon-rotate {
            animation: rotateIcon 0.3s ease-in-out;
        }

        @keyframes rotateIcon {
            0% {
                transform: rotate(0deg) scale(1);
            }

            50% {
                transform: rotate(180deg) scale(0.5);
            }

            100% {
                transform: rotate(360deg) scale(1);
            }
        }

        /* Efeitos hover */
        #theme-toggle-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .dark-theme #theme-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Efeito do Sol */
        #theme-toggle-btn i.fa-sun {
            animation: sunGlow 2s ease-in-out infinite alternate;
        }

        @keyframes sunGlow {
            from {
                text-shadow: 0 0 5px #fff,
                    0 0 10px #fff,
                    0 0 15px #ffd700,
                    0 0 20px #ffd700;
            }

            to {
                text-shadow: 0 0 10px #fff,
                    0 0 20px #fff,
                    0 0 30px #ffd700,
                    0 0 40px #ffd700;
            }
        }

        /* Efeito da Lua */
        #theme-toggle-btn i.fa-moon {
            animation: moonGlow 4s ease-in-out infinite;
        }

        @keyframes moonGlow {

            0%,
            100% {
                text-shadow: 0 0 5px rgba(110, 110, 110, 0.8),
                    0 0 10px rgba(110, 110, 110, 0.5);
            }

            50% {
                text-shadow: 0 0 8px rgba(110, 110, 110, 0.8),
                    0 0 15px rgba(110, 110, 110, 0.5);
            }
        }

        /* Efeito de pressionar */
        #theme-toggle-btn:active {
            transform: scale(0.9);
        }

        /* teste */

        /* Beta Agents Button */
        .beta-button {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(45deg, #6b46c1, #805ad5);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            margin-left: 10px;
            overflow: hidden;
        }

        .beta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(107, 70, 193, 0.4);
            background: linear-gradient(45deg, #805ad5, #6b46c1);
        }

        .beta-button i {
            font-size: 16px;
            animation: pulse 2s infinite;
        }

        .beta-tag {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff0066;
            color: white;
            font-size: 8px;
            padding: 3px 6px;
            border-radius: 8px;
            transform: rotate(15deg);
            font-weight: bold;
            animation: bounce 1s ease infinite;
        }

        .beta-tag2 {
            position: absolute;
            top: 55px;
            right: 65px;
            background: linear-gradient(45deg, #ff0066, #ff00ff);
            color: white;
            font-size: 14px;
            padding: 5px 10px;
            border-radius: 12px;
            transform: rotate(30deg);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            animation: pulse 2s ease-in-out infinite;
        }

        .beta-tag2:hover {
            transform: rotate(30deg) scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        @keyframes pulse {
            0% {
                transform: rotate(-30deg) scale(1);
            }

            30% {
                transform: rotate(-35deg) scale(1.05);
            }

            50% {
                transform: rotate(-25deg) scale(1);
            }

            75% {
                transform: rotate(-35deg) scale(1.05);
            }

            100% {
                transform: rotate(-30deg) scale(1);
            }
        }

        /* Modal do Beta Agents */
        .beta-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            backdrop-filter: blur(5px);
        }

        .beta-modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .beta-modal.dark-theme .beta-modal-content {
            background: #1a1a1a;
            color: white;
        }

        .beta-agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .agent-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .dark-theme .agent-card {
            background: #2d2d2d;
        }

        .agent-card:hover {
            transform: translateY(-5px);
            border-color: #6b46c1;
            box-shadow: 0 5px 15px rgba(107, 70, 193, 0.2);
        }

        .agent-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .agent-icon {
            font-size: 24px;
            color: #6b46c1;
        }

        .agent-name {
            font-weight: bold;
            font-size: 18px;
        }

        .agent-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .dark-theme .agent-description {
            color: #aaa;
        }

        .agent-status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 10px;
            background: #e9ecef;
            display: inline-block;
        }

        .dark-theme .agent-status {
            background: #404040;
        }

        .close-modal {
            position: absolute;
            top: 50px;
            right: 67px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            transition: all 0.3s ease;
        }

        .close-modal:hover {
            color: #ff0066;
            transform: rotate(90deg);
        }

        .dark-theme .close-modal {
            color: #fff;
        }

        /* FOR SCRIPTS */
        .agent-feedback {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(107, 70, 193, 0.9);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 10000;
            animation: slideIn 0.3s ease-out;
        }

        .agent-feedback-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .agent-feedback i {
            font-size: 20px;
        }

        /* Media Query for Mobile Devices */
        @media (max-width: 768px) {
            .main-content {
                width: 100%;
                height: 65%;
                /* Faz com que o main-content ocupe toda a largura da tela */
                padding: 10px;
                /* Ajusta o padding para melhor uso do espaço */
                margin: 0;
                /* Remove margens para maximizar o espaço */
                height: auto;
                /* Permite que a altura se ajuste automaticamente ao conteúdo */
                box-shadow: none;
                /* Remove sombras, se houver, para um visual mais limpo */
            }

            /* Caso tenha um título ou cabeçalho no main-content, ajuste o tamanho da fonte */
            .main-content h1,
            .main-content h2,
            .main-content h3 {
                font-size: 1.5em;
                /* Reduz o tamanho da fonte para cabeçalhos */
                margin-bottom: 10px;
                /* Ajusta o espaçamento inferior */
            }

            /* Ajusta o tamanho dos parágrafos e textos */
            .main-content p {
                font-size: 14px;
                /* Reduz o tamanho da fonte dos parágrafos */
                line-height: 1.5;
                /* Aumenta o espaçamento entre linhas para legibilidade */
            }
        }

        /* FullScreen Button */

        #fullscreen-btn {
            position: relative;
            margin-top: 100px;
            width: 100%;
            /* Faz com que o botão ocupe toda a largura da sidebar */
            padding: 10px;
            /* Aumenta o padding para facilitar o toque */
            font-size: 14px;
            /* Tamanho da fonte */
            border: none;
            /* Remove bordas padrão */
            background-color: #007bff;
            /* Cor de fundo do botão */
            color: white;
            /* Cor do texto */
            border-radius: 5px;
            /* Arredonda os cantos */
            cursor: grab;
            /* Muda o cursor ao passar o mouse */
        }

        #fullscreen-btn:hover {
            background-color: #0056b3;
            /* Cor ao passar o mouse */
        }

        /* Estilos da linha de versão */

        /* Version Timeline Styles */
        .version-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 2px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .version-line:hover {
            height: 4px;
            transform: translateY(-1px);
        }

        /* Version Colors */
        .version-0 {
            background-color: transparent;
        }

        .version-1 {
            background-color: #FFA500;
        }

        /* laranja */
        .version-2 {
            background-color: #800080;
        }

        /* roxo */
        .version-3 {
            background-color: #008000;
        }

        /* verde */
        .version-4 {
            background-color: #FF69B4;
        }

        /* rosa */
        .version-5 {
            background-color: #FF0000;
        }

        /* vermelho */
        .version-6 {
            background-color: #FFFF00;
        }

        /* amarelo */
        .version-7 {
            background-color: #0000FF;
        }

        /* azul */
        .version-8 {
            background-color: #006400;
        }

        /* verde escuro */
        .version-9 {
            background-color: #87CEEB;
        }

        /* azul bebê */
        .version-10 {
            background-color: #DAA520;
        }

        /* amarelo caramelo */

        .version-indicator {
            position: absolute;
            right: -30px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            display: none;
        }

        .version-line:hover .version-indicator {
            display: block;
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .message {
            padding: 8px 12px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background-color: var(--primary-color);
            color: white;
            align-self: flex-end;
        }

        .message.assistant {
            background-color: #f0f0f0;
            color: var(--text-color);
            align-self: flex-start;
        }
    </style>
</head>

<body>

    <div id="autonomous-background"></div>
    <div class="sidebar" id="sidebar">
        <div class="logo">
            <div class="logo-text">
                <span class="vps-text">VPS</span>
                <div class="globe" aria-label="Globo animado"></div>
                <span class="investech-text">by Investech technologies</span>
            </div>
        </div>
        <div class="nav-item"><a href="#"><i class="fas fa-cogs" aria-hidden="true"></i><span
                    class="nav-text">Settings</span></a></div>
        <div class="nav-item"><a href="#"><i class="fas fa-save" aria-hidden="true"></i><span
                    class="nav-text">Saves</span></a></div>
        <div class="nav-item"><a href="#"><i class="fas fa-layer-group" aria-hidden="true"></i><span
                    class="nav-text">Modelos</span></a></div>
        <div class="nav-item"><a href="#"><i class="fas fa-history" aria-hidden="true"></i><span
                    class="nav-text">Históricos</span></a></div>
        <div class="nav-item"><a href="#"><i class="fas fa-play-circle" aria-hidden="true"></i><span
                    class="nav-text">Visual Player Studio</span></a></div>
        <div class="nav-item"><a href="#"><i class="fas fa-star" aria-hidden="true"></i><span
                    class="nav-text">Favoritos</span></a></div>
        <!-- Adicione este botão na seção de cabeçalho do conteúdo -->
        <button id="theme-toggle-btn" aria-label="Toggle Theme"><i class="fas fa-moon"></i></button>
        <button id="fullscreen-btn"><i class="fas fa-expand-arrows-alt"></i></button>
    </div>
    <button class="toggle-btn" id="toggle-btn" aria-label="Toggle Sidebar"><i class="fas fa-chevron-left"
            aria-hidden="true"></i></button>
    <div class="content" id="content">
        <div class="header">
            <div class="search">
                <button id="chat-btn" aria-label="Open Chat">Chat VPS AI</button>
                <button id="version-log-btn" aria-label="Open Version Log">Version Log</button>
                <button id="download-btn" aria-label="Download HTML">Download HTML</button>
                <button id="autonomous-mode-btn" aria-label="Toggle Autonomous Mode">Modo Autônomo</button>
                <button id="pause-btn" aria-label="Pause Autonomous Mode">Pausar</button>
                <button id="beta-agents-btn" class="beta-button" aria-label="Beta Agents">
                    <i class="fas fa-robot"></i>
                    <span>Beta Agents</span>
                    <div class="beta-tag">BETA</div>
                </button>
            </div>
        </div>

        <div class="main-container">
            <div class="main-content">
                <iframe class="preview" id="preview" title="Code Preview"></iframe>
            </div>
            <div class="side-content">
                <textarea id="code-editor" placeholder="Write your code here..." aria-label="Code Editor"></textarea>
            </div>
        </div>
    </div>
    <div class="chat-popup" id="chat-popup">
        <div class="header">
            <h4>Chat VPS AI</h4>
            <button class="close-btn" id="close-chat-btn" aria-label="Close Chat">&times;</button>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="body">
            <input id="chat-input" placeholder="Type your message..." type="text" aria-label="Chat Input" />
            <button id="send-chat-btn" aria-label="Send Message">Send</button>
        </div>
    </div>
    <div class="popup" id="popup" aria-label="Popup"><i class="fas fa-quote-right" aria-hidden="true"></i></div>

    <div id="autonomous-popup" class="autonomous-popup">
        <div class="autonomous-popup-content">
            <h2>Teste o Modo Autonôno agora.</h2>
            <div class="beta-tag2">BETA</div>
            <div class="autonomous-input-group">
                <label for="autonomous-objective">Qual o objetivo do modo autônomo?</label>
                <input type="text" id="autonomous-objective" placeholder="Ex: Otimizar performance, melhorar design..."
                    aria-label="Autonomous Objective">
            </div>
            <div class="autonomous-input-group">
                <label for="autonomous-how">Como posso fazer isto? (opcional)</label>
                <input type="text" id="autonomous-how" placeholder="Instruções específicas..."
                    aria-label="Autonomous How">
            </div>
            <div class="autonomous-input-group">
                <label for="autonomous-error">Se eu encontrar um erro, permite que eu faça as escolhas para alternar
                    itens ou tudo mais?</label>
                <input type="text" id="autonomous-error" maxlength="250"
                    placeholder="Instruções para tratamento de erros..." aria-label="Autonomous Error Handling">
            </div>
            <div class="autonomous-input-group">
                <label>Devo gerar versões para cada modificação no código?</label>
                <div class="autonomous-radio-group">
                    <input type="radio" id="autonomous-versions-yes" name="autonomous-versions" value="yes"
                        aria-label="Generate Versions Yes">
                    <label for="autonomous-versions-yes">Sim</label>
                    <input type="radio" id="autonomous-versions-no" name="autonomous-versions" value="no"
                        aria-label="Generate Versions No">
                    <label for="autonomous-versions-no">Não</label>
                </div>
            </div>
            <p style="font-size: 12px; color: red;">O modo autonomo é uma função em beta que tende a ter alguns bugs critícos. Caso você encontre, avise-nos em nosso <a href="https://discord.gg/Hsgfnpx5MV" style="color: blue; text-decoration: none;">discord</a>.</p>
            <div class="autonomous-button-group">
                <button id="autonomous-start" class="autonomous-button"
                    aria-label="Start Autonomous Mode">Começar</button>
                <button id="autonomous-cancel" class="autonomous-button" aria-label="Cancel Autonomous Mode">Voltar
                    atrás</button>
            </div>
        </div>
    </div>

    <div id="version-log-popup" class="premium-popup">
        <div class="premium-popup-content">
            <h2>Histórico de Versões</h2>
            <p class="aviso">O histórico permanece salvo durante 90 dias, não se esqueça de salvar.</p>
            <div id="version-log-list"></div>
            <div id="version-info"
                style="display: none; margin-top: 10px; padding: 10px; background: rgba(255, 255, 255, 0.9); border-radius: 5px;">
            </div>
            <button id="close-version-log" aria-label="Close Version Log">Fechar</button>
            <button id="clear-version-log" aria-label="Clear Version Log">Limpar Histórico</button>
        </div>
    </div>

    <div id="loading-animation" class="loading-animation" style="display: none;">
        <div class="spinner" aria-label="Loading Spinner"></div>
        <p>Gerando código...</p>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/anyword-hint.min.js"></script>
    <script>
        // Sistema de gerenciamento de código em pedaços
        let codeChunks = new Map();
        let versionTimeline = [];
        let generatedText = ''; // Definindo a variável aqui
        // Acima - v.1.2

        // Abaixo - v.1.2-01

        // Adicione no início do script, junto com as outras variáveis globais
        let chatHistory = {
            messages: [],
            maxMessages: 50000 // Limite máximo de mensagens armazenadas
        };

        // Acima - v.1.2-01

        let autonomousMode = false;
        let autonomousInterval;
        let autonomousConfig = {};
        let versionCounter = 1;
        let versionHistory = [];
        let isPaused = false;
        let activeTabs = [];
        let activeTabIndex = 0;
        let files = new Map();
        let agentHistory = [];

        // Modificar o event listener do botão de envio
        document.getElementById('send-chat-btn').addEventListener('click', async function () {
            var chatInput = document.getElementById('chat-input');
            if (chatInput.value.trim() !== '') {
                const userMessage = chatInput.value;

                // Adicionar mensagem do usuário ao histórico
                addMessageToHistory(userMessage, true);

                const loadingAnimation = document.getElementById('loading-animation');
                loadingAnimation.style.display = 'flex';

                try {
                    const response = await getGeminiResponse(userMessage);
                    if (response) {
                        // Adicionar resposta do assistente ao histórico
                        addMessageToHistory(response.comment || 'Alterações aplicadas', false);

                        if (response.code) {
                            updateEditorWithAnimation(response.code);
                        }
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    addMessageToHistory('Desculpe, ocorreu um erro ao processar sua mensagem.', false);
                } finally {
                    loadingAnimation.style.display = 'none';
                    chatInput.value = '';
                }
            }
        });

        // Função para atualizar a interface do chat
        function updateChatInterface() {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = '';

            chatHistory.messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.type}`;
                messageElement.textContent = message.content;
                chatMessages.appendChild(messageElement);
            });

            // Rolar para a última mensagem
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        document.addEventListener('DOMContentLoaded', function () {
            // Carrega o histórico salvo
            if (isLocalStorageAvailable()) {
                try {
                    const savedHistory = JSON.parse(localStorage.getItem('versionHistory'));
                    if (Array.isArray(savedHistory)) {
                        versionHistory = savedHistory;
                        versionCounter = Math.max(...savedHistory.map(v => v.version), 0) + 1;
                        updateVersionLogPopup();
                        // Inicializa as linhas de versão após carregar o histórico
                        displayVersionLines(editor);
                    }
                } catch (e) {
                    console.error('Erro ao carregar histórico:', e);
                }
            }
            cleanupOldVersions();
        }); window.addEventListener('resize', function () {
            displayVersionLines(editor);
        });

        // Chame esta função no carregamento da página
        document.addEventListener('DOMContentLoaded', () => {
            addTimelineStyles();
        });

        document.getElementById('fullscreen-btn').addEventListener('click', function () {
            if (!document.fullscreenElement) {
                // Tenta entrar em modo de tela cheia
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Erro ao tentar ativar tela cheia: ${err.message}`);
                });
            } else {
                // Sai do modo de tela cheia
                document.exitFullscreen();
            }

            // Chama a função para reorganizar a UI
            organizeUIForFullscreen();
        });

        function organizeUIForFullscreen() {
            // Aqui você pode adicionar suas regras de CSS ou classes para reorganizar a UI
            const mainContent = document.querySelector('.main-content');
            if (document.fullscreenElement) {
                // Exemplo de ajustes para tela cheia
                mainContent.style.width = '100%'; // Faz com que o main-content ocupe toda a largura
                mainContent.style.height = '100%'; // Faz com que o main-content ocupe toda a altura
                // Adicione mais ajustes conforme necessário
            } else {
                // Reverte as alterações quando sair do modo de tela cheia
                mainContent.style.width = ''; // Volta ao tamanho original
                mainContent.style.height = ''; // Volta ao tamanho original
            }
        }

        // V.1.2 abaixo
        function addCodeChunk(key, code) {
            if (!codeChunks.has(key)) {
                codeChunks.set(key, code);
            } else {
                let existingCode = codeChunks.get(key);
                codeChunks.set(key, existingCode + '\n' + code);
            }
        }

        function getCodeChunk(key) {
            return codeChunks.get(key);
        }

        function removeCodeChunk(key) {
            codeChunks.delete(key);
        }

        function updateCodeChunk(key, newCode) {
            if (codeChunks.has(key)) {
                codeChunks.set(key, newCode);
            }
        }

        function processCodeModification(modification) {
            const delRegex = /\[DEL\]([\s\S]*?)\[\/DEL\]/g;
            const changeRegex = /\[CHANGE\]([\s\S]*?)\[\/CHANGE\]/g;
            const addRegex = /\[ADD\]([\s\S]*?)\[\/ADD\]/g;

            // Processa [DEL]
            modification = modification.replace(delRegex, (match, content) => {
                removeCodeChunk(content.trim());
                return '';
            });

            // Processa [CHANGE]
            modification = modification.replace(changeRegex, (match, content) => {
                const [key, newCode] = content.split('\n');
                updateCodeChunk(key.trim(), newCode.trim());
                return '';
            });

            // Processa [ADD]
            modification = modification.replace(addRegex, (match, content) => {
                const [key, code] = content.split('\n');
                addCodeChunk(key.trim(), code.trim());
                return '';
            });

            return modification;
        }

        // Funções para gerenciar o histórico de chat
        function addMessageToHistory(message, isUser = true) {
            const newMessage = {
                content: message,
                timestamp: new Date().toISOString(),
                type: isUser ? 'user' : 'assistant',
                id: Date.now()
            };

            chatHistory.messages.push(newMessage);

            // Limitar o número de mensagens
            if (chatHistory.messages.length > chatHistory.maxMessages) {
                chatHistory.messages = chatHistory.messages.slice(-chatHistory.maxMessages);
            }

            // Salvar no localStorage
            saveHistoryToLocalStorage();

            // Atualizar a interface
            updateChatInterface();
        }

        function saveHistoryToLocalStorage() {
            try {
                localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
            } catch (e) {
                console.error('Erro ao salvar histórico:', e);
            }
        }

        function loadHistoryFromLocalStorage() {
            try {
                const saved = localStorage.getItem('chatHistory');
                if (saved) {
                    chatHistory = JSON.parse(saved);
                }
            } catch (e) {
                console.error('Erro ao carregar histórico:', e);
            }
        }
        //Fim da V.1.2 acima

        // E esta função
        function logAgentAction(agentName, action, result) {
            agentHistory.push({
                agent: agentName,
                action: action,
                result: result,
                timestamp: new Date().toISOString()
            });

            // Salvar no localStorage
            try {
                localStorage.setItem('agentHistory', JSON.stringify(agentHistory));
            } catch (e) {
                console.error('Erro ao salvar histórico de agentes:', e);
            }
        }

        // Beta Agents Functionality
        document.getElementById('beta-agents-btn').addEventListener('click', function () {
            showBetaAgentsModal();
        });

        function showBetaAgentsModal() {
            // Criar modal
            const modal = document.createElement('div');
            modal.className = 'beta-modal';
            if (document.body.classList.contains('dark-theme')) {
                modal.classList.add('dark-theme');
            }

            // Adicione dentro da função showBetaAgentsModal(), após criar os cards
            const agentCards = modal.querySelectorAll('.agent-card');
            agentCards.forEach(card => {
                card.addEventListener('click', function () {
                    const agentName = this.querySelector('.agent-name').textContent;
                    const agentDescription = this.querySelector('.agent-description').textContent;
                    const status = this.querySelector('.agent-status').textContent;

                    if (status.includes('Em Breve')) {
                        alert('Este agente ainda não está disponível.');
                        return;
                    }

                    // Implementar a lógica específica para cada agente
                    switch (agentName) {
                        case 'Code Optimizer':
                            optimizeCode();
                            break;
                        case 'Style Enhancer':
                            enhanceStyle();
                            break;
                        case 'Debug Assistant':
                            debugCode();
                            break;
                        case 'AI Mentor':
                            provideMentoring();
                            break;
                    }
                });
            });


            // Conteúdo do modal
            modal.innerHTML = `
        <div class="beta-modal-content">
            <button class="close-modal">&times;</button>
            <h2 style="margin-bottom: 20px;">Beta Agents 🤖</h2>
            <p>Explore nossos agentes experimentais em desenvolvimento:</p>
            
            <div class="beta-agents-grid">
                <div class="agent-card">
                    <div class="agent-header">
                        <i class="fas fa-code agent-icon"></i>
                        <span class="agent-name">Code Optimizer</span>
                    </div>
                    <p class="agent-description">Otimiza automaticamente seu código para melhor performance.</p>
                    <span class="agent-status">Beta v0.1</span>
                </div>

                <div class="agent-card">
                    <div class="agent-header">
                        <i class="fas fa-magic agent-icon"></i>
                        <span class="agent-name">Style Enhancer</span>
                    </div>
                    <p class="agent-description">Melhora o design e a estética do seu código.</p>
                    <span class="agent-status">Beta v0.2</span>
                </div>

                <div class="agent-card">
                    <div class="agent-header">
                        <i class="fas fa-bug agent-icon"></i>
                        <span class="agent-name">Debug Assistant</span>
                    </div>
                    <p class="agent-description">Encontra e corrige bugs automaticamente.</p>
                    <span class="agent-status">Em Breve</span>
                </div>

                <div class="agent-card">
                    <div class="agent-header">
                        <i class="fas fa-brain agent-icon"></i>
                        <span class="agent-name">AI Mentor</span>
                    </div>
                 <p class="agent-description">Oferece dicas e sugestões para melhorar seu código.</p>
                    <span class="agent-status">Em Breve</span>
                </div>
            </div>
        </div>
    `;

            // Adicionar ao corpo do documento
            document.body.appendChild(modal);

            // Fechar modal
            modal.querySelector('.close-modal').addEventListener('click', function () {
                modal.remove();


            });


        }

        // Funções dos agentes
        function optimizeCode() {
            const currentCode = editor.getValue();
            getGeminiResponse(
                `Otimize este código para melhor performance:\n\n${currentCode}`,
                currentCode,
                '',
                true
            ).then(response => {
                if (response && response.code) {
                    updateEditorWithAnimation(response.code);
                }
            });
        }

        function enhanceStyle() {
            const currentCode = editor.getValue();
            getGeminiResponse(
                `Melhore o design e a estética deste código:\n\n${currentCode}`,
                currentCode,
                '',
                true
            ).then(response => {
                if (response && response.code) {
                    updateEditorWithAnimation(response.code);
                }
            });
        }

        function debugCode() {
            const currentCode = editor.getValue();
            getGeminiResponse(
                `Encontre e corrija possíveis bugs neste código:\n\n${currentCode}`,
                currentCode,
                '',
                true
            ).then(response => {
                if (response && response.code) {
                    updateEditorWithAnimation(response.code);
                }
            });
        }

        function provideMentoring() {
            const currentCode = editor.getValue();
            getGeminiResponse(
                `Analise este código e forneça sugestões de melhorias:\n\n${currentCode}`,
                currentCode,
                '',
                true
            ).then(response => {
                if (response && response.code) {
                    updateEditorWithAnimation(response.code);
                }
            });
        }

        // Adicione esta função
        function showAgentFeedback(agentName) {
            const feedback = document.createElement('div');
            feedback.className = 'agent-feedback';
            feedback.innerHTML = `
        <div class="agent-feedback-content">
            <i class="fas fa-spinner fa-spin"></i>
            <p>${agentName} está trabalhando...</p>
        </div>
    `;
            document.body.appendChild(feedback);
            return feedback;
        }



        // Adicione este código JavaScript
        document.getElementById('theme-toggle-btn').addEventListener('click', function () {
            const icon = this.querySelector('i');

            // Adiciona classe para animação de rotação
            icon.classList.add('theme-icon-rotate');

            // Aguarda metade da animação para trocar o ícone
            setTimeout(() => {
                icon.classList.toggle('fa-moon');
                icon.classList.toggle('fa-sun');
            }, 150);

            // Remove a classe de animação após a conclusão
            setTimeout(() => {
                icon.classList.remove('theme-icon-rotate');
            }, 300);

            // Toggle do tema
            document.body.classList.toggle('dark-theme');
        });

        document.getElementById('version-log-btn').addEventListener('click', function () {
            document.getElementById('version-log-popup').style.display = 'flex';
            updateVersionLogPopup();
        });

        document.getElementById('close-version-log').addEventListener('click', function () {
            document.getElementById('version-log-popup').style.display = 'none';
        });

        function isLocalStorageAvailable() {
            try {
                const test = 'test';
                localStorage.setItem(test, test);
                localStorage.removeItem(test);
                return true;
            } catch (e) {
                return false;
            }
        }

        function createNewFile(filename, code) {
            const file = {
                filename,
                versions: [{
                    version: 1,
                    code: code,
                    timestamp: new Date()
                }]
            };
            files.set(filename, file);
            addNewTab(filename, 1, code);
        }

        function updateFile(filename, newCode) {
            const file = files.get(filename);
            if (file) {
                file.versions.push({
                    version: file.versions.length + 1,
                    code: newCode,
                    timestamp: new Date()
                });
                addNewTab(filename, file.versions.length, newCode);
            }
        }

        function createNewTab(title, version, code) {
            return {
                id: Date.now(),
                title: title,
                version: version,
                code: code
            };
        }

        function addNewTab(title, version, code) {
            const newTab = createNewTab(title, version, code);
            activeTabs.push(newTab);
            activeTabIndex = activeTabs.length - 1;
            updateTabsUI();
        }

        function navigateTab(direction) {
            if (direction === -1 && activeTabIndex > 0) {
                activeTabIndex--;
            } else if (direction === 1 && activeTabIndex < activeTabs.length - 1) {
                activeTabIndex++;
            }
            updateTabsUI();
        }

        function updateTabsUI() {
            const tabsContainer = document.createElement('div');
            tabsContainer.className = 'tabs-container';

            const prevButton = document.createElement('button');
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevButton.onclick = () => navigateTab(-1);

            const nextButton = document.createElement('button');
            nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextButton.onclick = () => navigateTab(1);

            tabsContainer.appendChild(prevButton);
            const tabInfo = document.createElement('span');
            tabInfo.textContent = `${activeTabs[activeTabIndex].title} (v${activeTabs[activeTabIndex].version})`;
            tabsContainer.appendChild(tabInfo);
            tabsContainer.appendChild(nextButton);

            const editorContainer = document.querySelector('.side-content');
            editorContainer.insertBefore(tabsContainer, editor.getWrapperElement());
        }

        document.getElementById('clear-version-log').addEventListener('click', function () {
            if (confirm('Tem certeza que deseja limpar todo o histórico de versões?')) {
                clearVersionHistory();
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            if (isLocalStorageAvailable()) {
                try {
                    const savedHistory = JSON.parse(localStorage.getItem('versionHistory'));
                    if (Array.isArray(savedHistory)) {
                        versionHistory = savedHistory;
                        versionCounter = Math.max(...savedHistory.map(v => v.version), 0) + 1;
                        updateVersionLogPopup();
                    }
                } catch (e) {
                    console.error('Erro ao carregar histórico:', e);
                }
            }
            cleanupOldVersions();
        });

        function adjustLayout() {
            const mainContainer = document.querySelector('.main-container');
            const mainContent = document.querySelector('.main-content');
            const sideContent = document.querySelector('.side-content');

            if (window.innerWidth < 768) {
                // Para telas menores que 768px
                mainContainer.style.flexDirection = 'column';
                mainContent.style.width = '100%';
                mainContent.style.marginRight = '0';
                mainContent.style.marginBottom = '20px';
                sideContent.style.width = '100%';
            } else {
                // Para telas maiores ou iguais a 768px
                mainContainer.style.flexDirection = 'row';
                mainContent.style.width = '700px';
                sideContent.style.width = '400px';
            }
        }

        // Ajusta o layout ao carregar a página
        window.addEventListener('load', adjustLayout);

        // Ajusta o layout ao redimensionar a janela
        window.addEventListener('resize', adjustLayout);


        function generateVersionNumber(counter) {
            if (counter < 10) {
                return counter.toString();
            } else {
                const base = Math.floor((counter - 10) / 26);
                const letter = String.fromCharCode(97 + ((counter - 10) % 26)); // 97 é o código ASCII para 'a'
                return base > 0 ? `0${letter}${base}` : `0${letter}`;
            }
        }

        document.getElementById('autonomous-mode-btn').addEventListener('click', function () {
            document.getElementById('autonomous-popup').style.display = 'flex';
        });

        document.getElementById('autonomous-start').addEventListener('click', function () {
            autonomousConfig = {
                objective: document.getElementById('autonomous-objective').value,
                how: document.getElementById('autonomous-how').value,
                errorHandling: document.getElementById('autonomous-error').value,
                generateVersions: document.querySelector('input[name="autonomous-versions"]:checked').value === 'yes'
            };

            startAutonomousMode();
            document.getElementById('autonomous-popup').style.display = 'none';
        });

        document.getElementById('autonomous-cancel').addEventListener('click', function () {
            document.getElementById('autonomous-popup').style.display = 'none';
        });

        function generateThumbnail(htmlCode) {
            return new Promise((resolve) => {
                try {
                    const blob = new Blob([htmlCode], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const img = new Image();
                    img.src = url;
                    img.onerror = () => {
                        URL.revokeObjectURL(url);
                        resolve('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='); // 1x1 transparent PNG
                    };
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = 200;
                        canvas.height = 120;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, 200, 120);
                        URL.revokeObjectURL(url);
                        resolve(canvas.toDataURL());
                    };
                } catch (error) {
                    console.error(' Erro ao gerar thumbnail:', error);
                    resolve('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=');
                }
            });
        }

        //v.1.2 down
        async function saveCodeVersion(code, comment) {
            const previousCode = versionHistory.length > 0 ? versionHistory[versionHistory.length - 1].code : '';
            const summary = await generateVersionNumber(code, previousCode);
            const thumbnail = await generateThumbnail(code);
            const now = new Date();

            const versionNumber = generateVersionNumber(versionCounter);
            const newVersion = {
                version: versionCounter,
                versionNumber: versionNumber,
                code: code,
                comment: comment,
                summary: summary,
                thumbnail: thumbnail,
                timestamp: now.toLocaleString(),
                modifiedLines: findModifiedLines({ code: code }, code.split('\n')),
                previousCode: previousCode,
                modifiedLines: findModifiedLines({ previousCode: previousCode }, code.split('\n'))
            };


            editor.on('change', function () {
                // Código existente do preview
                var previewFrame = document.getElementById('preview');
                var preview = previewFrame.contentDocument || previewFrame.contentWindow.document;
                preview.open();
                preview.write(editor.getValue());
                preview.close();

                // Atualiza as linhas de versão
                displayVersionLines(editor);
            });

            versionHistory.push(newVersion);
            addVersionToTimeline(newVersion);
            versionCounter++;

            try {
                localStorage.setItem('versionHistory', JSON.stringify(versionHistory));
                localStorage.setItem('versionTimeline', JSON.stringify(versionTimeline));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    versionHistory = versionHistory.slice(-10);
                    versionTimeline = versionTimeline.slice(-10);
                    localStorage.setItem('versionHistory', JSON.stringify(versionHistory));
                    localStorage.setItem('versionTimeline', JSON.stringify(versionTimeline));
                }
            }

            console.log(`Nova versão do código salva (${versionCounter - 1}): ${comment}`);
            updateVersionLogPopup();
            displayVersionTimeline();
        }

        function addTimelineStyles() {
            const styleSheet = document.createElement('style');
            styleSheet.textContent = `
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .version-timeline {
            position: fixed;
            right: 20px;
            top: 20px;
            width: 350px;
            max-height: 80vh;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 20px;
            z-index: 1000;
            animation: fadeIn 0.5s ease-out;
            transition: all 0.3s ease;
        }

        .version-timeline::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border: 2px solid #3498db;
            border-radius: 18px;
            animation: spin 8s linear infinite;
        }

        .version-timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .version-timeline-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }

        .version-timeline-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.3s ease;
        }

        .version-timeline-close:hover {
            color: #e74c3c;
        }

        .version-node {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .version-node:hover {
            background-color: #f7f9f9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .version-node-title {
            font-weight: bold;
            color: #34495e;
            margin-bottom: 5px;
        }

        .version-node-comment {
            font-size: 14px;
            color: #7f8c8d;
        }

        .version-node-timestamp {
            font-size: 12px;
            color: #95a5a6;
            margin-top: 5px;
        }

        .version-details-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            z-index: 1001;
            max-width: 80vw;
            max-height: 80vh;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }
    `;
            document.head.appendChild(styleSheet);
        }

        // Chame esta função no carregamento da página
        document.addEventListener('DOMContentLoaded', addTimelineStyles);

        // v.1.2 upper

        function clearVersionHistory() {
            versionHistory = [];
            versionCounter = 1;
            localStorage.removeItem('versionHistory');
            updateVersionLogPopup();
        }

        function cleanupOldVersions() {
            const MAX_AGE_DAYS = 90;
            const now = new Date();

            versionHistory = versionHistory.filter(version => {
                const versionDate = new Date(version.timestamp);
                const ageDays = (now - versionDate) / (1000 * 60 * 60 * 24);
                return ageDays <= MAX_AGE_DAYS;
            });

            localStorage.setItem('versionHistory', JSON.stringify(versionHistory));
            updateVersionLogPopup();
        }

        // Certifique-se de chamar cleanupOldVersions ao carregar a página
        document.addEventListener('DOMContentLoaded', function () {
            cleanupOldVersions();
        });

        function updateVersionLogPopup() {
            const versionLogList = document.getElementById('version-log-list');
            versionLogList.innerHTML = '';
            versionHistory.forEach((version, index) => {
                const versionItem = document.createElement('div');
                versionItem.className = 'version-item';
                versionItem.innerHTML = `
                    <img src="${version.thumbnail}" alt="Thumbnail" class="version-thumbnail">
                    <div>
                        <strong>Versão ${version.version}</strong> (${version.timestamp})
                        <p>${version.summary}</p>
                    </div>
                `;
                versionItem.addEventListener('dblclick', () => downloadVersionCode(index));
                versionLogList.appendChild(versionItem);
            });
        }

        async function runAutonomousIteration() {
            while (autonomousMode && !isPaused) {
                const currentCode = editor.getValue();
                const prompt = `
Objetivo: ${autonomousConfig.objective}
Como fazer: ${autonomousConfig.how}
Tratamento de erros: ${autonomousConfig.errorHandling}

Analise e melhore o seguinte código de acordo com as instruções acima:

${currentCode}

Histórico de versões:
${versionHistory.map(v => `Versão ${v.version}: ${v.comment}`).join('\n')}

${autonomousConfig.generateVersions ? "Gere uma nova versão do código com as alterações realizadas." : ""}

Por favor, analise o código atual, faça melhorias de acordo com o objetivo e as instruções, e forneça um comentário sobre as alterações feitas. Gere uma resposta em HTML, CSS e JS em arquivo único.`;

                const response = await getGeminiResponse(prompt, currentCode, versionHistory.length > 0 ? versionHistory[versionHistory.length - 1].code : '', true);

                if (response && response.code) {
                    if (autonomousConfig.generateVersions) {
                        await saveCodeVersion(response.code, response.comment);
                    }

                    await updateEditorWithAnimation(response.code);
                    displayVersionLines(versionCounter - 1, response.comment);

                    await new Promise(resolve => setTimeout(resolve, 60000));
                }
            }
        }

        document.getElementById('pause-btn').addEventListener('click', function () {
            isPaused = !isPaused;
            this.textContent = isPaused ? 'Retomar' : 'Pausar';
            if (!isPaused && autonomousMode) {
                runAutonomousIteration();
            }
        });

        function startAutonomousMode() {
            autonomousMode = true;
            isPaused = false;
            document.getElementById('autonomous-mode-btn').textContent = 'Desativar Modo Autônomo';
            document.getElementById('pause-btn').style.display = 'inline-block';

            const background = document.getElementById('autonomous-background');
            const body = document.body;

            body.classList.add('autonomous-mode');
            background.style.opacity = '1';

            runAutonomousIteration();
        }

        function stopAutonomousMode() {
            autonomousMode = false;
            isPaused = false;
            document.getElementById('autonomous-mode-btn').textContent = 'Modo Autônomo';
            document.getElementById('pause-btn').style.display = 'none';

            const background = document.getElementById('autonomous-background');
            const body = document.body;

            body.classList.remove('autonomous-mode');
            background.style.opacity = '0';
        }

        function downloadVersionCode(index) {
            const version = versionHistory[index];
            const blob = new Blob([version.code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `version_${version.version}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('version-log-btn').addEventListener('click', function () {
            document.getElementById('version-log-popup').style.display = 'flex';
            updateVersionLogPopup();
        });

        document.getElementById('close-version-log').addEventListener('click', function () {
            document.getElementById('version-log-popup').style.display = 'none';
        });

        function updateEditorWithAnimation(newCode) {
            let i = 0;
            const chunkSize = 50; // Aumenta o tamanho do chunk para animação mais rápida
            let isAnimating = true;

            const updateInterval = setInterval(() => {
                if (!isAnimating) return;

                editor.setValue(newCode.slice(0, i));
                i += chunkSize;

                // Scroll para a última linha durante a animação
                if (isAnimating) {
                    const lastLine = editor.lineCount() - 1;
                    editor.scrollIntoView({ line: lastLine, ch: 0 });
                }

                if (i > newCode.length) {
                    clearInterval(updateInterval);
                    isAnimating = false;
                    // Permite que o usuário role livremente após a animação
                    editor.focus();
                }
            }, 10); // Reduz o intervalo para animação mais rápida

            // Permite que o usuário continue editando durante a animação
            editor.setOption('readOnly', false);
        }

        // V.1.2 added down

        function addVersionToTimeline(version) {
            versionTimeline.push(version);
        }

        function displayVersionLines(editor) {
            // Remove existing version lines
            editor.clearGutter('version-gutter');

            // Get all versions
            const versions = versionHistory.slice().reverse();

            // Create a gutter for version lines
            editor.setGutterMarker('version-gutter', null, null);

            versions.forEach((version, index) => {
                if (version.modifiedLines) {
                    version.modifiedLines.forEach(lineNumber => {
                        const marker = document.createElement('div');
                        marker.className = `version-line version-${index % 11}`; // Use modulo to cycle through 11 colors
                        marker.innerHTML = `<span class="version-indicator">v${version.version}</span>`;
                        editor.setGutterMarker(lineNumber, 'version-gutter', marker);

                        // Add hover effect
                        marker.addEventListener('mouseenter', () => {
                            marker.querySelector('.version-indicator').style.display = 'block';
                        });
                        marker.addEventListener('mouseleave', () => {
                            marker.querySelector('.version-indicator').style.display = 'none';
                        });
                    });
                }
            });
        }

        function displayVersionTimeline() {
            const existingTimeline = document.querySelector('.version-timeline');
            if (existingTimeline) {
                existingTimeline.remove();
            }

            if (versionTimeline.length === 0) return;

            const timeline = document.createElement('div');
            timeline.className = 'version-timeline';

            // Adiciona cabeçalho com botão de fechar
            const header = document.createElement('div');
            header.className = 'version-timeline-header';
            header.innerHTML = `
        <h3>Timeline de Versões</h3>
        <button class="close-btn">&times;</button>
    `;
            timeline.appendChild(header);

            // Adiciona os nós da timeline
            versionTimeline.forEach((version, index) => {
                const node = document.createElement('div');
                node.className = 'version-node';
                node.innerHTML = `
            <div class="version-info">
                <span class="version-number">v${version.version}</span>
                <span class="version-time">${version.timestamp}</span>
            </div>
            <div class="version-comment">${version.comment || 'Sem comentário'}</div>
        `;
                timeline.appendChild(node);
            });

            document.body.appendChild(timeline);

            // Auto-close após 8 segundos
            setTimeout(() => {
                timeline.style.opacity = '0';
                timeline.style.transform = 'translateX(100%)';
                setTimeout(() => timeline.remove(), 300);
            }, 8000);

            // Botão de fechar
            header.querySelector('.close-btn').addEventListener('click', () => {
                timeline.remove();
            });
        }

        function findModifiedLines(version, currentLines) {
            // Se não houver versão anterior, todas as linhas são consideradas novas
            if (!version.previousCode) {
                return Array.from({ length: currentLines.length }, (_, i) => i);
            }

            const previousLines = version.previousCode.split('\n');
            const modifiedLines = new Set();

            // Função auxiliar para calcular a similaridade entre duas strings
            function similarity(str1, str2) {
                if (str1 === str2) return 1.0;
                if (str1.length === 0 || str2.length === 0) return 0.0;

                const longer = str1.length > str2.length ? str1 : str2;
                const shorter = str1.length > str2.length ? str2 : str1;
                const longerLength = longer.length;

                if (longerLength === 0) return 1.0;

                const costs = new Array(shorter.length + 1);
                for (let i = 0; i <= shorter.length; i++) {
                    costs[i] = i;
                }

                let currentValue, insertions, deletions, substitutions;
                for (let i = 1; i <= longer.length; i++) {
                    costs[0] = i;
                    let nw = i - 1;
                    for (let j = 1; j <= shorter.length; j++) {
                        currentValue = costs[j];
                        costs[j] = Math.min(
                            costs[j] + 1,
                            costs[j - 1] + 1,
                            nw + (longer[i - 1] !== shorter[j - 1] ? 1 : 0)
                        );
                        nw = currentValue;
                    }
                }

                return (longerLength - costs[shorter.length]) / longerLength;
            }

            // Detecta linhas modificadas usando comparação com threshold
            const SIMILARITY_THRESHOLD = 0.8;
            const checkedPrevLines = new Set();

            currentLines.forEach((currentLine, currentIndex) => {
                if (currentLine.trim() === '') return;

                let foundMatch = false;
                let bestMatchIndex = -1;
                let bestMatchScore = 0;

                // Procura a linha mais similar na versão anterior
                previousLines.forEach((prevLine, prevIndex) => {
                    if (checkedPrevLines.has(prevIndex)) return;
                    if (prevLine.trim() === '') return;

                    const score = similarity(currentLine, prevLine);
                    if (score > SIMILARITY_THRESHOLD && score > bestMatchScore) {
                        bestMatchScore = score;
                        bestMatchIndex = prevIndex;
                        foundMatch = true;
                    }
                });

                if (foundMatch) {
                    // Se encontrou uma linha similar mas não idêntica, marca como modificada
                    if (bestMatchScore < 1.0) {
                        modifiedLines.add(currentIndex);
                    }
                    checkedPrevLines.add(bestMatchIndex);
                } else {
                    // Se não encontrou match, é uma linha nova
                    modifiedLines.add(currentIndex);
                }
            });

            // Detecta linhas removidas
            previousLines.forEach((prevLine, prevIndex) => {
                if (!checkedPrevLines.has(prevIndex) && prevLine.trim() !== '') {
                    // Linha foi removida, marca a linha atual mais próxima
                    modifiedLines.add(Math.min(prevIndex, currentLines.length - 1));
                }
            });

            // Detecta mudanças estruturais
            const structuralPatterns = [
                /<\/?[a-zA-Z][^>]*>/g,  // Tags HTML
                /{[^}]*}/g,             // Blocos CSS/JS
                /function\s+\w+\s*\([^)]*\)/g, // Declarações de função
                /class\s+\w+/g,         // Declarações de classe
                /import\s+.*?from/g,    // Importações
                /@media\s+[^{]+{/g,     // Media queries
            ];

            currentLines.forEach((line, index) => {
                structuralPatterns.forEach(pattern => {
                    if (pattern.test(line)) {
                        const prevLine = previousLines[index];
                        if (!prevLine || !pattern.test(prevLine)) {
                            modifiedLines.add(index);
                            // Adiciona também algumas linhas de contexto
                            for (let i = Math.max(0, index - 2); i <= Math.min(currentLines.length - 1, index + 2); i++) {
                                modifiedLines.add(i);
                            }
                        }
                    }
                });
            });

            // Adiciona linhas de contexto em torno das modificações
            const contextLines = new Set();
            modifiedLines.forEach(lineNum => {
                for (let i = Math.max(0, lineNum - 1); i <= Math.min(currentLines.length - 1, lineNum + 1); i++) {
                    contextLines.add(i);
                }
            });

            // Detecta mudanças em blocos de código
            let inBlock = false;
            let blockStart = -1;
            currentLines.forEach((line, index) => {
                if (line.includes('{')) {
                    inBlock = true;
                    blockStart = index;
                }
                if (line.includes('}') && inBlock) {
                    inBlock = false;
                    if (modifiedLines.has(blockStart) || modifiedLines.has(index)) {
                        for (let i = blockStart; i <= index; i++) {
                            modifiedLines.add(i);
                        }
                    }
                }
            });

            return [...new Set([...modifiedLines, ...contextLines])].sort((a, b) => a - b);
        }

        function showVersionDetails(index) {
            const version = versionTimeline[index];
            const detailsPopup = document.createElement('div');
            detailsPopup.className = 'version-details-popup';
            detailsPopup.innerHTML = `
        <h3>Versão ${version.version}</h3>
        <p>${version.comment}</p>
        <pre>${version.code}</pre>
        <button onclick="this.parentElement.remove()">Fechar</button>
    `;
            document.body.appendChild(detailsPopup);
        }

        // End v1.2 version upper

        var editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            mode: 'htmlmixed',
            lineNumbers: true,
            theme: 'default',
            lineWrapping: true,
            gutters: ["CodeMirror-linenumbers", "version-gutter"], // Adicione esta linha
            extraKeys: {
                'Alt-Z': function (cm) {
                    cm.setOption('lineWrapping', !cm.getOption('lineWrapping'));
                },
                'Ctrl-Space': 'autocomplete',
                'Tab': function (cm) {
                    var hint = cm.state.completionActive.widget.data.list[cm.state.completionActive.widget.selectedHint];
                    if (hint) cm.replaceRange(hint.text, hint.from, hint.to);
                    else cm.execCommand('defaultTab');
                }
            }
        });

        // Adicione isto após a criação do editor
        editor.on('change', function () {
            // Atualiza o preview
            var previewFrame = document.getElementById('preview');
            var preview = previewFrame.contentDocument || previewFrame.contentWindow.document;
            preview.open();
            preview.write(editor.getValue());
            preview.close();

            // Atualiza as linhas de versão
            displayVersionLines(editor);

        });

        window.addEventListener('resize', function () {
            displayVersionLines(editor);
        });

        // Inicialização inicial das linhas de versão
        setTimeout(() => {
            displayVersionLines(editor);
        }, 100);

        editor.on('change', function () {
            var previewFrame = document.getElementById('preview');
            var preview = previewFrame.contentDocument || previewFrame.contentWindow.document;
            preview.open(); preview.write(editor.getValue()); preview.close();
        });

        document.getElementById('toggle-btn').addEventListener('click', function () {
            var sidebar = document.getElementById('sidebar');
            var content = document.getElementById('content');
            var logoText = document.querySelector('.logo-text');
            if (sidebar.classList.contains('collapsed')) {
                sidebar.classList.remove('collapsed');
                content.style.marginLeft = '250px';
                this.style.left = '250px';
                logoText.style.display = 'flex';
            } else {
                sidebar.classList.add('collapsed');
                content.style.marginLeft = '60px';
                this.style.left = '60px';
                logoText.style.display = 'none';
            }
            this.classList.toggle('collapsed');
        });

        function showLoadingNotification() {
            const notification = document.createElement('div');
            notification.className = 'loading-notification';
            notification.innerHTML = `
        <div class="spinner"></div>
        <span>Gerando código...</span>
    `;
            document.body.appendChild(notification);
            return notification;
        }

        async function generateVersionNumber(currentCode, previousCode) {
            try {
                const response = await getGeminiResponse('', currentCode, previousCode, false, true);
                return response.comment || 'Versão atualizada';
            } catch (error) {
                console.error('Erro ao gerar número da versão:', error);
                return 'Nova versão';
            }
        }

        async function getGeminiResponse(prompt, currentCode, previousCode, isImprovement = false, isSummary = false) {
            const loadingNotification = showLoadingNotification();
            try {
                let fullPrompt;
                if (isSummary) {
                    fullPrompt = `Analise as diferenças entre o código anterior e o código atual, e forneça um breve resumo das alterações:

Código anterior:
${previousCode}

Código atual:
${currentCode}

Por favor, forneça um resumo conciso das principais alterações realizadas.`;
                } else {
                    fullPrompt = `Você é parte do Visual Player Code Studio (VPS) da Investech, operando no modo autônomo. 
            
INSTRUÇÕES IMPORTANTES PARA MODIFICAÇÃO DE CÓDIGO:
Use os seguintes comandos para modificar o código:

1. Para REMOVER código:
[DEL]
código_a_ser_removido
[/DEL]

2. Para MODIFICAR código existente:
[CHANGE]
identificador_do_trecho
novo_código
[/CHANGE]

3. Para ADICIONAR novo código:
[ADD]
identificador_do_trecho
novo_código
[/ADD]

Exemplo de uso:
[DEL]
<div class="old-class">Conteúdo antigo</div>
[/DEL]

[ADD]
header
<header class="new-header">Novo cabeçalho</header>
[/ADD]

[CHANGE]
main-content
<main class="updated-main">Conteúdo atualizado</main>
[/CHANGE>

Por favor, use estes comandos ao sugerir modificações no código.

${prompt}

Versão atual do código (${versionCounter}):
${currentCode}

Código anterior:
${previousCode}

Histórico de versões:
${versionHistory.map(v => `Versão ${v.version}: ${v.comment}`).join('\n')}

${isImprovement ? "Este é um pedido de melhoria adicional. Use os comandos [DEL], [CHANGE] e [ADD] para fazer as modificações necessárias." : ""}

Analise o código atual e forneça suas modificações usando os comandos especificados acima. Em seguida, forneça um comentário explicando as alterações realizadas.`;
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=AIzaSyDmAQ1RqlvSmkPUD8rE27QS9VMpGOn-EGE`;
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: fullPrompt }] }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMessage = errorData.error ? errorData.error.message : response.statusText;
                    throw new Error(`Erro na API Gemini: ${response.status} - ${errorMessage}`);
                }

                const data = await response.json();
                console.log("Resposta completa da API:", data);

                if (!data.candidates || data.candidates.length === 0) {
                    throw new Error('Nenhuma resposta gerada pela API');
                }

                generatedText = data.candidates[0].content.parts[0].text; // Aqui é onde geramos o texto
                console.log("Texto gerado:", generatedText);

                // Processa as modificações de código
                const processedText = validateCodeModifications(generatedText)
                    ? processCodeModification(generatedText)
                    : generatedText;

                if (isSummary) {
                    return {
                        comment: processedText.trim()
                    };
                } else {
                    let codeMatch = processedText.match(/```html\n([\s\S]*?)\n```/) ||
                        processedText.match(/```([\s\S]*?)```/) ||
                        [null, processedText];

                    let commentMatch = processedText.match(/Comentário sobre as alterações:\n([\s\S]*?)(\n```|$)/) ||
                        [null, "Vamos falar sobre o código. :)"];

                    if (codeMatch && codeMatch[1]) {
                        const newCode = codeMatch[1].trim();
                        const versionComment = commentMatch[1].trim();

                        return {
                            code: newCode,
                            comment: versionComment
                        };
                    } else {
                        throw new Error('Formato de resposta inesperado da API');
                    }
                }
            } catch (error) {
                console.error('Erro detalhado:', error);
                alert(`Erro no modo autônomo: ${error.message}`);
            } finally {
                loadingNotification.remove();
            }
        }
        // Added in v.1.2 down

        function validateCodeModifications(text) {
            const delCount = (text.match(/\[DEL\]/g) || []).length;
            const delEndCount = (text.match(/\[\/DEL\]/g) || []).length;
            const changeCount = (text.match(/\[CHANGE\]/g) || []).length;
            const changeEndCount = (text.match(/\[\/CHANGE\]/g) || []).length;
            const addCount = (text.match(/\[ADD\]/g) || []).length;
            const addEndCount = (text.match(/\[\/ADD\]/g) || []).length;

            if (delCount !== delEndCount || changeCount !== changeEndCount || addCount !== addEndCount) {
                console.warn('Comandos de modificação mal formados na resposta');
                return false;
            }

            return true;
        }

        // Adicione esta validação antes de processar o texto:
        const processedText = validateCodeModifications(generatedText)
            ? processCodeModification(generatedText)
            : generatedText;

        // Added in v.1.2 up

        document.getElementById('send-chat-btn').addEventListener('click', async function () {
            var chatInput = document.getElementById('chat-input');
            if (chatInput.value !== '') {
                const loadingAnimation = document.getElementById('loading-animation');
                loadingAnimation.style.display = 'flex';

                const response = await getGeminiResponse(chatInput.value);
                if (response && response.code) {
                    updateEditorWithAnimation(response.code);
                }
                loadingAnimation.style.display = 'none';
                chatInput.value = '';
            }
        });

        document.getElementById('chat-btn').addEventListener('click', function () {
            document.getElementById('chat-popup').classList.add('active');
        });
        document.getElementById('close-chat-btn').addEventListener('click', function () {
            document.getElementById('chat-popup').classList.remove('active');
        });
        editor.on('inputRead', function (cm, change) {
            if (change.text[0] === ' ') return;
            CodeMirror.commands.autocomplete(cm, null, { completeSingle: false });
        });

        editor.on('inputRead', function (cm, change) {
            if (change.text[0] === '>' || change.text[0] === '/') {
                cm.execCommand('closeTag');
            }
        });

        var snippets = {
            'html': '<!DOCTYPE html>\n<html lang="en">\n<head>\n\t<meta charset="UTF-8">\n\t<meta name="viewport" content="width=device-width, initial-scale=1.0">\n\t<title>Document</title>\n</head>\n<body>\n\t\n</body>\n</html>',
            'div': '<div>\n\t\n</div>',
            'for': 'for (let i = 0; i < ; i++) {\n\t\n}'
        };

        editor.on('inputRead', function (cm, change) {
            if (change.text[0] === ' ' && snippets[cm.getRange(change.from, change.to)]) {
                cm.replaceRange(snippets[cm.getRange(change.from, change.to)], change.from, change.to);
            }
        });

        var htmlHint = function (cm, options) {
            var cursor = cm.getCursor();
            var token = cm.getTokenAt(cursor);
            var start = token.start;
            var end = cursor.ch;
            var line = cm.getLine(cursor.line);
            var currentWord = line.slice(start, end);

            var list = [];
            var seen = {};
            var re = new RegExp('^' + currentWord, 'i');

            function add(str) {
                if (!seen[str] && re.test(str)) {
                    seen[str] = true;
                    list.push(str);
                }
            }

            ['div', 'span', 'p', 'a', 'img', 'button', 'form', 'input'].forEach(add);
            ['class', 'id', 'style', 'href', 'src'].forEach(add);

            return { list: list, from: CodeMirror.Pos(cursor.line, start), to: CodeMirror.Pos(cursor.line, end) };
        };

        editor.setOption('hintOptions', { hint: htmlHint });

        editor.setOption('extraKeys', {
            'Enter': function (cm) {
                cm.execCommand('newlineAndIndent');
            }
        });
        editor.on('cursorActivity', function (cm) {
            var selection = cm.getSelection();
            var popup = document.getElementById('popup');
            if (selection) {
                var cursor = cm.getCursor();
                var coords = cm.charCoords(cursor, 'page');
                popup.style.top = (coords.top + window.scrollY - 30) + 'px';
                popup.style.left = (coords.left + window.scrollX - 30) + 'px';
                popup.style.display = 'block';
            } else {
                popup.style.display = 'none';
            }
        });

        document.getElementById('popup').addEventListener('click', function () {
            var selection = editor.getSelection();
            var fullCode = editor.getValue();
            var chatPopup = document.getElementById('chat-popup');
            var chatInput = document.getElementById('chat-input');

            chatPopup.classList.add('active');

            if (selection.length / fullCode.length > 0.8) {
                chatInput.value = `Modifique o seguinte código completo, com foco especial na parte selecionada:\n\nCódigo completo:\n${fullCode}\n\nParte selecionada:\n${selection}`;
            } else {
                chatInput.value = `Modifique a seguinte parte do código :\n\n${selection}\n\nNo contexto do código completo:\n${fullCode}`;
            }
        });

        function downloadHTML() {
            const code = editor.getValue();
            const blob = new Blob([code], { type: 'text/html' });
            const url = URL.createObjectURL(blob);

            const titleMatch = code.match(/<title>(.*?)<\/title>/);
            const title = titleMatch ? titleMatch[1] : 'untitled';

            const a = document.createElement('a');
            a.href = url;
            a.download = `${title}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        document.getElementById('download-btn').addEventListener('click', downloadHTML);

        document.getElementById('send-chat-btn').addEventListener('click', async function () {
            var chatInput = document.getElementById('chat-input');
            if (chatInput.value !== '') {
                const loadingAnimation = document.getElementById('loading-animation');
                loadingAnimation.style.display = 'flex';

                const response = await getGeminiResponse(chatInput.value);
                if (response) {
                    let i = 0;
                    const interval = setInterval(() => {
                        editor.setValue(response.slice(0, i));
                        i += 1;
                        if (i > response.length) {
                            clearInterval(interval);
                            loadingAnimation.style.display = 'none';
                        }
                    }, 50);
                }
                chatInput.value = '';
            }
        });
    </script>
</body>

</html>